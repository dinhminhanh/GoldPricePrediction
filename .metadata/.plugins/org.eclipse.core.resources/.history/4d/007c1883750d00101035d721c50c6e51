package crawler;

import java.awt.Checkbox;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.concurrent.TimeUnit;
import org.json.JSONObject;
import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import driver.AMyDriverContext;
import driver.ChromeDriverContext;
import database.model.OpenSeaModel;

public class GoldCrawler extends AMyCrawler {
	
	private static final String     URL = "https://vn.investing.com/commodities/gold" ;
	private static final String     JSON_PATH = "gold.json" ;
	
	public GoldCrawler(AMyDriverContext myDriver) {
		super(myDriver);
	}
	
	@Override
	public boolean crawl() {
		boolean check = true ;
		driver.get(URL);
        driver.manage().window().maximize();
        driver.manage().deleteAllCookies();
        driver.manage().timeouts().pageLoadTimeout(40, TimeUnit.SECONDS);
        driver.manage().timeouts().implicitlyWait(30, TimeUnit.SECONDS);
        WebDriverWait wait = new WebDriverWait(driver, 50);
    	wait.until(ExpectedConditions.presenceOfElementLocated(By.cssSelector("div[data-test='instrument-header-details']")));
		JavascriptExecutor js = (JavascriptExecutor) driver;
		try {
			Thread.sleep(3000);
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
		while (jdata.length() < 95) {
            wait.until(ExpectedConditions.presenceOfElementLocated(By.cssSelector("div[data-test='instrument-header-details']")));
            try {
				Thread.sleep(3000);
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
            WebElement n = driver.findElement(By.cssSelector("div[data-test='instrument-header-details']"));
            
            	try {  
            		// GetPrice
                    WebElement priceElement = n.findElement(By.cssSelector("div[data-test='instrument-price-last']"));
                    String floorPrice = priceElement.getText();
                    System.out.println("Price: " + floorPrice);
                    
                    // GetPercentChange
                    WebElement percentElement = n.findElement(By.cssSelector("div[data-test='instrument-price-change-percent']"));
                    String percentChange = percentElement.getText();
                    System.out.println("%Change: " + percentChange);
                               
                    // GetSales
                    WebElement salesElement = n.findElement(By.cssSelector("div:nth-child(5) > span:nth-child(1)"));
            		String saleString = salesElement.getText();
            		if (saleString.contains(","))      saleString = saleString.replace(",", "");
            		else if (saleString.contains("K")) saleString = saleString.replace("K", "");
            		int sales = Integer.parseInt(saleString) ;
            		System.out.println("Sales: " + sales);
            		
            		// Get DateTime
            		LocalDateTime currentDateTime = LocalDateTime.now();
        		    DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
        		    String dateString = currentDateTime.format(formatter);
        		    
        		    // Put to JsonObject
            		JSONObject a = new JSONObject();
                    a.put("rank", rank) ;
                    a.put("collection"  , name);
                    a.put("volume",volume);
                    a.put("percentChange", percentChange) ;
                    a.put("floorPrice", floorPrice) ;
                    a.put("sales", sales) ;
                    a.put("date", dateString) ;
        	        
                    jdata.put(a);
                    System.out.println(" ");
				 } catch (NumberFormatException e) {
					System.out.println("Error!");
			     }	
                  
             js.executeScript("window.scrollBy(0,2200)");
		}
		driver.quit();
		
		Set<String> uniqueJsonStrings = new HashSet<>();
	    int length = jdata.length();
	
	    for (int i = 0; i < length; i++) {
	        JSONObject jsonObject = jdata.getJSONObject(i);
	        String jsonString = jsonObject.toString();
	
	        if (uniqueJsonStrings.contains(jsonString)) {
	            jdata.remove(i);
	            i--; 
	            length--; 
	        } 
	        else   uniqueJsonStrings.add(jsonString);
	     }	
	    
		saveAsJsonFile(JSON_PATH);
		return check ;
	}
	
}

