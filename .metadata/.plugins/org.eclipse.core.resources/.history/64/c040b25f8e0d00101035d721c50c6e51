package crawler;

import java.awt.Checkbox;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.concurrent.TimeUnit;
import org.json.JSONObject;
import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import driver.AMyDriverContext;
import driver.ChromeDriverContext;
import database.model.OpenSeaModel;

public class GoldCrawler extends AMyCrawler {
	
	private static final String     URL = "https://vn.investing.com/commodities/gold" ;
	private static final String     JSON_PATH = "gold.json" ;
	
	public GoldCrawler(AMyDriverContext myDriver) {
		super(myDriver);
	}
	
	@Override
	public boolean crawl() {
		boolean check = true ;
		driver.get(URL);
        driver.manage().window().maximize();
        driver.manage().deleteAllCookies();
        driver.manage().timeouts().pageLoadTimeout(40, TimeUnit.SECONDS);
        driver.manage().timeouts().implicitlyWait(30, TimeUnit.SECONDS);
        WebDriverWait wait = new WebDriverWait(driver, 50);
    	wait.until(ExpectedConditions.presenceOfElementLocated(By.cssSelector("div[data-test='instrument-header-details']")));
		JavascriptExecutor js = (JavascriptExecutor) driver;
		try {
			Thread.sleep(3000);
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
		while (jdata.length() < 95) {
            wait.until(ExpectedConditions.presenceOfElementLocated(By.cssSelector("div[data-test='instrument-header-details']")));
            try {
				Thread.sleep(3000);
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
            WebElement n = driver.findElement(By.cssSelector("div[data-test='instrument-header-details']"));
            
            	try {  
            		// GetPrice
                    WebElement priceElement = n.findElement(By.cssSelector("div[data-test='instrument-price-last']"));
                    String price = priceElement.getText();
                    System.out.println("Price: " + price);
                    
                    // GetChange
                    WebElement changeElement = n.findElement(By.cssSelector("div[data-test='instrument-price-change']"));
                    String change = changeElement.getText();
                    System.out.println("Change: " + change);
                    
                    // GetPercentChange
                    WebElement percentElement = n.findElement(By.cssSelector("div[data-test='instrument-price-change-percent']"));
                    String percentChange = percentElement.getText();
                    System.out.println("%Change: " + percentChange);

        		    
        		    // Put to JsonObject
            		JSONObject a = new JSONObject();
                    a.put("price", price) ;
                    a.put("change"  , change);
                    a.put("percentChange", percentChange);
                    a.put("date", dateString) ;
        	        
                    jdata.put(a);
                    System.out.println(" ");
				 } catch (NumberFormatException e) {
					System.out.println("Error!");
			     }	
		}
		driver.quit();
		
		Set<String> uniqueJsonStrings = new HashSet<>();
	    int length = jdata.length();
	
	    for (int i = 0; i < length; i++) {
	        JSONObject jsonObject = jdata.getJSONObject(i);
	        String jsonString = jsonObject.toString();
	
	        if (uniqueJsonStrings.contains(jsonString)) {
	            jdata.remove(i);
	            i--; 
	            length--; 
	        } 
	        else   uniqueJsonStrings.add(jsonString);
	     }	
	    
		saveAsJsonFile(JSON_PATH);
		return check ;
	}
	
}

